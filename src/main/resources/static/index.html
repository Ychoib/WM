<!doctype html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>WM Dashboard</title>
    <style>
      :root {
        --bg-1: #0f1220;
        --bg-2: #151a2b;
        --card: #171d33;
        --card-2: #0f1426;
        --stroke: #2a3253;
        --text: #e8ecff;
        --muted: #a7b0d6;
        --accent: #39c2ff;
        --warning: #ffb74d;
        --danger: #ff5c7a;
        --good: #35d07f;
      }

      * { box-sizing: border-box; }

      body {
        margin: 0;
        font-family: "Space Grotesk", "IBM Plex Sans", "Noto Sans KR", sans-serif;
        color: var(--text);
        background:
          radial-gradient(1200px 500px at 10% -10%, #1c2250 0%, transparent 60%),
          radial-gradient(800px 600px at 90% 10%, #12314a 0%, transparent 55%),
          linear-gradient(160deg, var(--bg-1), var(--bg-2));
        min-height: 100vh;
      }

      .page {
        padding: 32px 28px 48px;
        max-width: 1200px;
        margin: 0 auto;
      }

      .topbar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 16px;
        margin-bottom: 28px;
      }

      .brand {
        display: flex;
        align-items: center;
        gap: 14px;
      }

      .logo {
        width: 38px;
        height: 38px;
        border-radius: 10px;
        background: linear-gradient(135deg, #2a6bff, #34d2ff);
        box-shadow: 0 10px 28px rgba(52, 210, 255, 0.35);
      }

      h1 {
        font-size: 22px;
        margin: 0;
        letter-spacing: 0.2px;
      }

      .subtitle {
        color: var(--muted);
        font-size: 13px;
        margin-top: 4px;
      }

      .cta {
        display: flex;
        gap: 10px;
      }

      .btn {
        border: 1px solid var(--stroke);
        background: linear-gradient(180deg, #1d2440, #141a2d);
        color: var(--text);
        padding: 10px 14px;
        border-radius: 10px;
        font-size: 13px;
        cursor: pointer;
        text-decoration: none;
      }

      .btn.primary {
        border-color: transparent;
        background: linear-gradient(135deg, #2a6bff, #34d2ff);
        color: #0b1022;
        font-weight: 600;
      }

      .grid {
        display: grid;
        grid-template-columns: repeat(12, 1fr);
        gap: 18px;
      }

      .card {
        background: linear-gradient(180deg, var(--card), var(--card-2));
        border: 1px solid var(--stroke);
        border-radius: 16px;
        padding: 18px;
        box-shadow: 0 20px 40px rgba(6, 10, 25, 0.45);
      }

      .kpis {
        grid-column: span 12;
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 14px;
      }

      .kpi {
        padding: 16px;
        border-radius: 14px;
        border: 1px solid var(--stroke);
        background: rgba(255, 255, 255, 0.02);
      }

      .kpi .label {
        color: var(--muted);
        font-size: 12px;
      }

      .kpi .value {
        font-size: 26px;
        margin-top: 8px;
        font-weight: 600;
      }

      .kpi .trend {
        margin-top: 8px;
        font-size: 12px;
        color: var(--muted);
      }

      .danger { color: var(--danger); }
      .warning { color: var(--warning); }
      .good { color: var(--good); }

      .list {
        grid-column: span 7;
      }

      .heatmap {
        grid-column: span 5;
      }

      .section-title {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 12px;
      }

      .section-title h2 {
        font-size: 16px;
        margin: 0;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 13px;
      }

      th, td {
        text-align: left;
        padding: 10px 8px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.06);
      }

      th {
        color: var(--muted);
        font-weight: 500;
      }

      .tag {
        display: inline-block;
        padding: 3px 8px;
        border-radius: 999px;
        font-size: 11px;
        border: 1px solid var(--stroke);
        color: var(--muted);
      }

      .tag.danger { border-color: rgba(255, 92, 122, 0.6); color: var(--danger); }
      .tag.warning { border-color: rgba(255, 183, 77, 0.6); color: var(--warning); }
      .tag.good { border-color: rgba(53, 208, 127, 0.6); color: var(--good); }

      .alert-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 8px;
        background: var(--danger);
        box-shadow: 0 0 10px rgba(255, 92, 122, 0.8);
        animation: pulse 1.2s ease-in-out infinite;
      }

      @keyframes pulse {
        0% { transform: scale(0.9); opacity: 0.7; }
        50% { transform: scale(1.2); opacity: 1; }
        100% { transform: scale(0.9); opacity: 0.7; }
      }

      .name-cell {
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .mini-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 10px;
      }

      .cell {
        padding: 14px;
        border-radius: 12px;
        background: rgba(255, 255, 255, 0.02);
        border: 1px solid var(--stroke);
        min-height: 86px;
      }

      .cell .label { color: var(--muted); font-size: 12px; }
      .cell .value { font-size: 18px; margin-top: 8px; }

      .foot {
        grid-column: span 12;
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 18px;
      }

      .full-table {
        grid-column: span 12;
      }

      .timeline {
        display: grid;
        gap: 10px;
      }

      .event {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 10px 12px;
        border-radius: 12px;
        border: 1px solid var(--stroke);
        background: rgba(255, 255, 255, 0.02);
        font-size: 13px;
      }

      .dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: var(--accent);
      }

      .empty {
        color: var(--muted);
        font-size: 13px;
        text-align: center;
        padding: 24px 0;
      }

      .policy-list {
        display: grid;
        gap: 10px;
      }

      .filters {
        display: grid;
        grid-template-columns: 1.2fr 1fr 1fr 1fr 1fr;
        gap: 10px;
        margin-bottom: 12px;
      }

      .filters input, .filters select {
        width: 100%;
        background: rgba(255, 255, 255, 0.02);
        border: 1px solid var(--stroke);
        border-radius: 10px;
        color: var(--text);
        padding: 8px 10px;
        font-size: 12px;
      }

      .filters select, .filters select option {
        background-color: #111726;
        color: var(--text);
      }

      .filters .btn {
        padding: 8px 10px;
        font-size: 12px;
      }

      .policy-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 10px 12px;
        border-radius: 12px;
        border: 1px solid var(--stroke);
        background: rgba(255, 255, 255, 0.02);
        font-size: 13px;
      }

      @media (max-width: 980px) {
        .kpis { grid-template-columns: repeat(2, 1fr); }
        .list { grid-column: span 12; }
        .heatmap { grid-column: span 12; }
        .foot { grid-template-columns: 1fr; }
        .filters { grid-template-columns: 1fr 1fr; }
      }

      @media (max-width: 640px) {
        .topbar { flex-direction: column; align-items: flex-start; }
        .kpis { grid-template-columns: 1fr; }
        .cta { width: 100%; }
        .btn { flex: 1; }
        .filters { grid-template-columns: 1fr; }
      }
    </style>
  </head>
  <body>
    <div class="page">
      <div class="topbar">
        <div class="brand">
          <div class="logo" aria-hidden="true"></div>
          <div>
            <h1>만료 리스크 대시보드</h1>
            <div class="subtitle">라이선스 · SSL · 도메인 · 계약 갱신 상태 한눈에</div>
          </div>
        </div>
        <div class="cta">
          <a class="btn" href="/policy.html">알림 정책</a>
          <button class="btn">CSV 내보내기</button>
          <a class="btn primary" href="/add.html">자산 추가</a>
        </div>
      </div>

      <div class="grid">
        <div class="kpis">
          <div class="kpi">
            <div class="label">D-90 이내 만료</div>
            <div class="value warning" id="kpi-d90">-</div>
            <div class="trend" id="kpi-d90-trend">지난 7일 신규 +0</div>
          </div>
          <div class="kpi">
            <div class="label">D-30 이내 만료</div>
            <div class="value danger" id="kpi-d30">-</div>
            <div class="trend" id="kpi-d30-trend">지난 7일 신규 +0</div>
          </div>
          <div class="kpi">
            <div class="label">정상 유지</div>
            <div class="value good" id="kpi-healthy">-</div>
            <div class="trend" id="kpi-healthy-trend">지난 7일 신규 +0</div>
          </div>
          <div class="kpi">
            <div class="label">알림 미설정</div>
            <div class="value" id="kpi-no-policy">-</div>
            <div class="trend" id="kpi-no-policy-trend">지난 7일 신규 +0</div>
          </div>
        </div>

        <div class="card list">
          <div class="section-title">
            <h2>임박 만료 항목</h2>
            <span class="tag warning">D-30</span>
          </div>
          <table>
            <thead>
              <tr>
                <th>자산명</th>
                <th>유형</th>
                <th>만료일</th>
                <th>담당</th>
                <th>상태</th>
              </tr>
            </thead>
            <tbody id="expiry-body">
              <tr>
                <td colspan="5" class="empty">데이터를 불러오는 중...</td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="card heatmap">
          <div class="section-title">
            <h2>팀별 리스크 분포</h2>
            <span class="tag">최근 90일</span>
          </div>
          <div class="mini-grid" id="team-risk">
            <div class="cell">
              <div class="label">로딩 중</div>
              <div class="value">-</div>
            </div>
          </div>
        </div>

        <div class="card foot">
          <div>
            <div class="section-title">
              <h2>최근 변경 이력</h2>
              <span class="tag">최근 등록 기준</span>
            </div>
            <div class="timeline" id="recent-changes">
              <div class="event">
                <div class="dot"></div>
                <div>데이터를 불러오는 중...</div>
              </div>
            </div>
          </div>
          <div>
            <div class="section-title">
              <h2>알림 정책</h2>
            </div>
            <div class="policy-list" id="policy-list">
              <div class="policy-item">
                <span>로딩 중</span>
                <span>-</span>
              </div>
            </div>
          </div>
        </div>

        <div class="card full-table">
          <div class="section-title">
            <h2>전체 만료 현황</h2>
            <span class="tag">모든 시스템</span>
          </div>
          <div class="filters">
            <input id="filter-text" placeholder="자산명 검색" />
            <select id="filter-type">
              <option value="">유형 전체</option>
            </select>
            <input id="filter-team" placeholder="담당팀" />
            <select id="filter-policy">
              <option value="">정책 전체</option>
            </select>
            <select id="filter-range">
              <option value="">기간 전체</option>
              <option value="expired">만료됨</option>
              <option value="30">D-30 이내</option>
              <option value="90">D-90 이내</option>
            </select>
          </div>
          <table>
            <thead>
              <tr>
                <th>자산명</th>
                <th>유형</th>
                <th>만료일</th>
                <th>담당</th>
                <th>정책</th>
              </tr>
            </thead>
            <tbody id="all-expiry-body">
              <tr>
                <td colspan="5" class="empty">데이터를 불러오는 중...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <script>
      const fmtStatus = (daysLeft) => {
        if (daysLeft <= 7) return { cls: 'danger', label: `D-${daysLeft}` };
        if (daysLeft <= 30) return { cls: 'warning', label: `D-${daysLeft}` };
        return { cls: 'good', label: `D-${daysLeft}` };
      };

      const renderItems = (items) => {
        const body = document.getElementById('expiry-body');
        if (!items || items.length === 0) {
          body.innerHTML = '<tr><td colspan="5" class="empty">임박 만료 항목이 없습니다.</td></tr>';
          return;
        }
        body.innerHTML = items.map(item => {
          const status = fmtStatus(item.daysLeft);
          const alert = item.daysLeft <= 7;
          return `
            <tr>
              <td>
                <div class="name-cell">
                  ${alert ? '<span class="alert-dot" title="임박 만료"></span>' : ''}
                  <a href="/edit.html?id=${item.id}" style="color: inherit; text-decoration: none;">${item.name}</a>
                </div>
              </td>
              <td>${item.type}</td>
              <td>${item.expiresAt}</td>
              <td>${item.ownerTeam ?? '-'}</td>
              <td><span class="tag ${status.cls}">${status.label}</span></td>
            </tr>
          `;
        }).join('');
      };

      const renderCounts = (counts) => {
        document.getElementById('kpi-d90').textContent = counts?.d90 ?? '-';
        document.getElementById('kpi-d30').textContent = counts?.d30 ?? '-';
        document.getElementById('kpi-healthy').textContent = counts?.healthy ?? '-';
        document.getElementById('kpi-no-policy').textContent = counts?.noPolicy ?? '-';
        document.getElementById('kpi-d90-trend').textContent = `지난 7일 신규 +${counts?.d90New ?? 0}`;
        document.getElementById('kpi-d30-trend').textContent = `지난 7일 신규 +${counts?.d30New ?? 0}`;
        document.getElementById('kpi-healthy-trend').textContent = `지난 7일 신규 +${counts?.healthyNew ?? 0}`;
        document.getElementById('kpi-no-policy-trend').textContent = `지난 7일 신규 +${counts?.noPolicyNew ?? 0}`;
      };

      const renderTeamRisk = (teams) => {
        const container = document.getElementById('team-risk');
        if (!teams || teams.length === 0) {
          container.innerHTML = '<div class="cell"><div class="label">데이터 없음</div><div class="value">-</div></div>';
          return;
        }
        container.innerHTML = teams.map(team => `
          <div class="cell">
            <div class="label">${team.team ?? '미지정'}</div>
            <div class="value">${team.count}건</div>
          </div>
        `).join('');
      };

      const renderPolicies = (policies) => {
        const container = document.getElementById('policy-list');
        if (!policies || policies.length === 0) {
          container.innerHTML = '<div class="policy-item"><span>미설정</span><span>0</span></div>';
          return;
        }
        container.innerHTML = policies.map(policy => `
          <div class="policy-item">
            <span>${policy.policy}</span>
            <span>${policy.count}</span>
          </div>
        `).join('');
      };

      const renderRecent = (items) => {
        const container = document.getElementById('recent-changes');
        if (!items || items.length === 0) {
          container.innerHTML = '<div class="event"><div class="dot"></div><div>최근 등록 내역이 없습니다.</div></div>';
          return;
        }
        container.innerHTML = items.map(item => `
          <div class="event">
            <div class="dot"></div>
            <div>${item.name} · ${item.type} · ${item.ownerTeam ?? '미지정'} · ${item.createdAt}</div>
          </div>
        `).join('');
      };

      const renderAllExpiry = (items) => {
        const body = document.getElementById('all-expiry-body');
        if (!items || items.length === 0) {
          body.innerHTML = '<tr><td colspan="5" class="empty">데이터가 없습니다.</td></tr>';
          return;
        }
        body.innerHTML = items.map(item => {
          const alert = (item.daysLeft ?? 9999) <= 7;
          return `
          <tr>
            <td>
              <div class="name-cell">
                ${alert ? '<span class="alert-dot" title="임박 만료"></span>' : ''}
                <a href="/edit.html?id=${item.id}" style="color: inherit; text-decoration: none;">${item.name}</a>
              </div>
            </td>
            <td>${item.type}</td>
            <td>${item.expiresAt}</td>
            <td>${item.ownerTeam ?? '-'}</td>
            <td>${item.notifyPolicy ?? '미설정'}</td>
          </tr>
        `}).join('');
      };

      const populateFilters = (items) => {
        const typeSet = new Set();
        const policySet = new Set();
        items.forEach(item => {
          if (item.type) typeSet.add(item.type);
          const policy = item.notifyPolicy ?? '미설정';
          policySet.add(policy);
        });

        const typeSelect = document.getElementById('filter-type');
        const policySelect = document.getElementById('filter-policy');

        typeSelect.innerHTML = '<option value="">유형 전체</option>' +
          [...typeSet].sort().map(t => `<option value="${t}">${t}</option>`).join('');

        policySelect.innerHTML = '<option value="">정책 전체</option>' +
          [...policySet].sort().map(p => `<option value="${p}">${p}</option>`).join('');
      };

      const applyFilters = () => {
        const text = document.getElementById('filter-text').value.trim().toLowerCase();
        const type = document.getElementById('filter-type').value;
        const team = document.getElementById('filter-team').value.trim().toLowerCase();
        const policy = document.getElementById('filter-policy').value;
        const range = document.getElementById('filter-range').value;

        const filtered = (window.allAssets || []).filter(item => {
          if (text && !item.name.toLowerCase().includes(text)) return false;
          if (type && item.type !== type) return false;
          if (team && !(item.ownerTeam ?? '').toLowerCase().includes(team)) return false;
          const itemPolicy = item.notifyPolicy ?? '미설정';
          if (policy && itemPolicy !== policy) return false;

          if (range) {
            const daysLeft = item.daysLeft ?? null;
            if (range === 'expired' && (daysLeft === null || daysLeft >= 0)) return false;
            if (range === '30' && (daysLeft === null || daysLeft > 30 || daysLeft < 0)) return false;
            if (range === '90' && (daysLeft === null || daysLeft > 90 || daysLeft < 0)) return false;
          }

          return true;
        });

        renderAllExpiry(filtered);
      };

      fetch('/api/dashboard')
        .then(res => res.ok ? res.json() : Promise.reject(res.status))
        .then(data => {
          renderCounts(data.counts);
          renderItems(data.items);
          renderTeamRisk(data.teamRisks);
          renderPolicies(data.policyCounts);
          renderRecent(data.recentChanges);
        })
        .catch(() => {
          renderCounts(null);
          renderItems([]);
          renderTeamRisk([]);
          renderPolicies([]);
          renderRecent([]);
        });

      fetch('/api/assets')
        .then(res => res.ok ? res.json() : Promise.reject(res.status))
        .then(data => {
          window.allAssets = data.map(item => {
            const expires = item.expiresAt ? new Date(item.expiresAt) : null;
            const today = new Date();
            const daysLeft = expires ? Math.floor((expires - new Date(today.getFullYear(), today.getMonth(), today.getDate())) / 86400000) : null;
            return { ...item, daysLeft };
          });
          populateFilters(window.allAssets);
          applyFilters();
        })
        .catch(() => renderAllExpiry([]));

      ['filter-text', 'filter-type', 'filter-team', 'filter-policy', 'filter-range']
        .forEach(id => {
          const el = document.getElementById(id);
          el.addEventListener('input', applyFilters);
          el.addEventListener('change', applyFilters);
        });
    </script>
  </body>
</html>
